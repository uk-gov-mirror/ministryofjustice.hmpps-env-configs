---
- name: Get github token from SSM
  set_fact:
    github_token: "{{ lookup('aws_ssm', github_token_ssm ) }}"
  no_log: true

- name: Import source credentials into CodeBuild
  shell: aws codebuild import-source-credentials --token '{{ github_token }}' --server-type GITHUB --auth-type PERSONAL_ACCESS_TOKEN --output text
  register: source_creds
  no_log: true

- name: Add source credentials ARN to parameter store
  aws_ssm_parameter_store:
    name: "{{ source_credentials_ssm }}"
    description: ARN of the CodeBuild Source Credentials holder, containing the GitHub access token.
    string_type: String
    value: "{{ source_creds.stdout }}"
